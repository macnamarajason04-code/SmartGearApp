@model IEnumerable<SmartGearApp.Models.Product>

@{
    ViewData["Title"] = "SmartGear Products";
}

<div class="container mt-4">
    <h2 class="text-center text-primary mb-4">SmartGear Products</h2>

    <div id="updateAlert" class="alert alert-info text-center d-none">
        üîÑ Product list updated in real-time!
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a asp-controller="Product" asp-action="Create" class="btn btn-success">‚ûï Add New Product</a>
        <button id="manualRefresh" class="btn btn-outline-info">üîÑ Manual Refresh</button>
    </div>

    <table class="table table-bordered table-striped text-center" id="productTable">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price (R)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Id</td>
                    <td>@item.Name</td>
                    <td>@item.Category</td>
                    <td>@item.Price</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-product" data-id="@item.Id">Edit</button>
                        <button class="btn btn-sm btn-danger delete-product" data-id="@item.Id">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/productHub")
            .build();

        connection.on("ReceiveUpdate", function (message) {
            const alert = document.getElementById("updateAlert");
            alert.classList.remove("d-none");
            refreshProductList();

            setTimeout(() => {
                alert.classList.add("d-none");
            }, 3000);
        });

        connection.start().catch(err => console.error(err));

        function refreshProductList() {
            $.ajax({
                url: '/api/productapi',
                method: 'GET',
                success: function (data) {
                    let rows = '';
                    data.forEach(p => {
                        rows += `
                            <tr>
                                <td>${p.id}</td>
                                <td>${p.name}</td>
                                <td>${p.category}</td>
                                <td>${p.price}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning edit-product" data-id="${p.id}">Edit</button>
                                    <button class="btn btn-sm btn-danger delete-product" data-id="${p.id}">Delete</button>
                                </td>
                            </tr>`;
                    });
                    $('#productTable tbody').html(rows);
                },
                error: function () {
                    console.error('‚ùå Failed to refresh product list.');
                }
            });
        }

        $('#manualRefresh').click(refreshProductList);

        $(document).on('click', '.delete-product', function () {
            const id = $(this).data('id');
            if (!confirm('Are you sure you want to delete this product?')) return;

            $.ajax({
                url: `/api/productapi/${id}`,
                method: 'DELETE',
                success: function () {
                    console.log('üóëÔ∏è Product deleted');
                    refreshProductList();
                    connection.invoke("SendUpdate", "Product deleted");
                },
                error: function () {
                    alert('‚ùå Failed to delete product.');
                }
            });
        });

        $(document).on('click', '.edit-product', function () {
            const id = $(this).data('id');
            window.location.href = `/Product/Edit/${id}`;
        });
    </script>
}
